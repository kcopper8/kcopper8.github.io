title: hexo-source-deployer-git (5)
date: 2016-05-01 17:27:52
tags:
---
[hexo-source-deployer-git (4)](/2016/05/01/hexo-source-deployer-git-4/) 에서 계속

## git_push 모듈
... 을 만드는 데는 별 문제 없었다. spawn 실행시킬 때 실행 디렉토리 값 넣는 걸 깜박하고 테스트를 돌렸다가 소스코드 커밋이 일어나버린 것을 제외하면.

만들고 나서 보니 테스트가 부족한 것을 발견했다. 이걸로는 초기 commit 보다는 사용하고 있는 중의 것을 commit 하는 일이 더 많을텐데 이미 존재하는 local repository 에서 commit 하는 테스트가 준비되어 있지 않았다.

### 이미 존재하는 local repository 에서 commit 하는 테스트
이런 식으로 한번 내용물을 변경한 디렉토리와 그걸 push 후 clone 받은 디렉토리를 비교하는 validation 을 짜려니 무척 번거로워서 찾아보기로 했다. [node-dir-diff](https://github.com/bingomanatee/node-dir-diff) 라는 녀석이 보여서 이녀석을 사용하기로 했다.

노드는 굉장하구나. 찾으면 다 있을지도 모르겠다는 생각이 들었.. 지만, 생각해보니 지금 내가 만들고 있는 건 없어서 만드는 거잖아? ;;; 필요한 거라면 누가 이미 만들었을테고 이걸 내가 만들고 있다는 것은 나 말고는 안 필요한 물건이라는 걸지도 모르겠다. 다른 사람들은 어떻게 사용하고 있는 걸까.

하지만 node-dir-diff 는 사용하는 데 실패했다. 설치하는 과정에서 node-gyp 라는 녀석을 사용하는 것 같은데 이 녀석이 .net framework 를 사용하다 실패했다. 딱히 해결하기 위해 노력하고 싶지 않아지는 녀석이라, 다른 녀석을 찾아보았다. [dir-compare](https://github.com/gliviu/dir-compare) 라는 녀석을 찾았다. 다행히 이 녀석은 잘 설치되었다.

이걸로 기존 validation 로직을 변경했다. .git 파일이 양쪽에 있어서 살짝 불편했는데, `excludeFilter` 파라메터가 있어서 회피할 수 있었다. 이걸 jasmine helper 에다가 matcher 로 만들어 넣으려고 했는데, 비동기적으로 동작하는 matcher 를 만들려면 문서를 다시 열어봐야 해서 미뤘다. 공부 주제 목록에 넣어놨다.

이걸로 테스트를 추가했다. 추가 자체는 생각보다 쉽게 되었는데, 읽기 쉬운 테스트를 만드는 것은 아직 좀 무리인 것 같다.



### 다른 branch 로 commit 하는 테스트

branch 를 변경해서 commit 하는 것 역시 빠뜨린 상태였다. 추가하기로 했다. 기능 자체는 금방 추가한 줄 알았다.

테스트를 만들었는데, 돌려봤더니 실패했다. 이건 아무래도 git 의 초기화 상태에서의 push 에 대한 이해 부족 때문에 발생한 현상인 것 같았다.

일단 상황을 확인하기 위해서 afterEach 의 디렉토리 중간 결과물을 원래대로 돌리는 로직을 막아두고 테스트를 돌려봤더니, `done()` 이 사용되지 않아서 timeout 이 났다. 이거 귀찮다! `chai` 는 혹시 더 나은가?!

아. 글 또 날릴 뻔 했다; 

여튼 확인해보니, 예상과 달랐다. 테스트는 정상이었고, 로직에 미스가 있어서 실패한 아주 정상적인 상황이었다. 문제는 지난번 글에서 예상한 것과 같이 테스트가 자기가 실패한 원인을 알려주지 못한 데 있었다. 문제를 미리 예상한 것이 기뻐해야할지 미뤄놨던 게 결국 터져서 우울해 해야할지.

일단 또 미루기로 했다. 일일히 하나씩 다 해결해 나가다간 이거 완성 못하겠다!!

여튼 문제는 확인했다. lodash defaults 를 쓸 때 파라메터 왼쪽과 오른쪽을 헷갈린 문제였다...

어.. 일단 의외로 git_push 다 된 것 같네. 왜 잘 실행되지? 어이없네.

